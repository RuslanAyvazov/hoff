Attribute VB_Name = "main"




Sub runner(ByVal pBU_fromUI As String)

If services.check_existing_all_columns = False Then Exit Sub
services.clear_new_shablon_sheet
services.formatting_data

Library.connectionUnitialization

n = pBU_fromUI

vMainLoops = Library.get_shablons_counter
For i = 0 To UBound(vMainLoops, 2)
    Dim vScepkaDct As New Dictionary
    vScepkaDct.RemoveAll
    
    vScepkaDct.Add "supplier", vMainLoops(0, i)
    vScepkaDct.Add "tg", vMainLoops(1, i)
    vScepkaDct.Add "ng", vMainLoops(2, i)

    
    '2.1.    Для каждой записи в шаблоне проверяем, есть ли для записи в колонке "Бизнес-юнит" значение в справочнике "Справочник кластеров":
    proverka_2_1 = Library.checkNCluster(n)
    If proverka_2_1 Then
        Debug.Print "БЮ есть в справочнике кластеров"
    Else:
        Debug.Print "БЮ нет в справочнике кластеров"
    End If
    
    '2.1.1.   Если значения нет, то строка из текущего шаблона копируется в новый шаблон без изменений.
    If proverka_2_1 = 0 Then
            Call points.if_bu_is_not_exists_in_cluster_tbl_point_2_1(n, vScepkaDct)
            GoTo next_shablon
    
    End If
    
    '2.3.    Определяем по справочнику "Справочник кластеров", является ли выбранный склад кластерным
    proverka_2_3 = Library.checkNCluster(n, 1)
    If proverka_2_3 Then
        Debug.Print "Склад является кластерным"
    Else:
        Debug.Print "Склад не является кластерным"
    End If
    
    '2.3.1.  Если склад НЕ кластерный, то меняем цепочку только для заданного склада и записываем ее в новый шаблон, по остальным складам копируем в новый шаблон текущие записи
    If proverka_2_3 = 0 Then
        Call points.if_wh_is_not_clustered_point_2_3_1(n, vScepkaDct)
        GoTo next_shablon
    End If

    
    '2.3.2.  Если склад кластерный, то по справочнику "Справочник кластеров" проверяем, какие склады связаны с этим кластером.
    subclastered_wh_list = Library.get_subclustered_wh_id(n)
    Debug.Print "Подчиненные склады: " & Join(subclastered_wh_list, ",")
    
    '2.4.    Для складов, НЕ связанных с кластером, копируем имеющиеся записи в новый шаблон
    Call points.if_wh_is_not_sub_clustered_point_2_4(n, vScepkaDct, subclastered_wh_list)
    
    '2.5.    Для складов, связанных с кластером, последовательно для каждого склада проводим проверку:
    '2.5.1.  Если для кластерного склада цепочка поменялась на Поставщика, то для его подчиненных складов:
    If Library.check_bu_chain_for_supplier(n, vScepkaDct) > 0 Then
        Debug.Print "Для склада поменялась цепочка на Поставщика"
        '2.5.1.1.    Если для БЮ подчиненного склада значение в поле Модель пополнения = "Поставщик", то ничего не меняем и копируем строку
        '2.5.1.2.    Если для БЮ подчиненного склада значение в поле Модель пополнения = "Бизнес-юнит", то в поле БЮ пополнения записываем код БЮ кластерного склада
        Call points.if_wh_is_sub_clustered_point_2_5(n, vScepkaDct, subclastered_wh_list)
    '2.5.2.  Иначе, если для кластерного склада цепочка поменялась на Бизнес-юнит, то для его подчиненных складов:
    Else:
        Debug.Print "Для склада поменялась цепочка на Бизнес-юнит"
        '2.5.2.1.    Если для БЮ подчиненного склада значение в поле Модель пополнения = "Поставщик", то ничего не меняем и копируем строку
        '2.5.2.2.    Если для БЮ подчиненного склада значение в поле Модель пополнения = "Бизнес-юнит", то в поле БЮ пополнения записываем код БЮ =770.
        Call points.if_wh_is_sub_clustered_point_2_5(n, vScepkaDct, subclastered_wh_list, 1)
    End If
    
next_shablon:
Next i
    
Con.Close
Set Con = Nothing

    

End Sub


